# Testing the contracts

## Overview

This document describes the process to use the MeshJS off-chain framework to generate wallets for admin, offerer, and claimant; distribute some testnet Ada to the wallets to pay fees; create the minting policy for our bridge NFT; create the bridge validator script; mint the NFT and lock it at the bridge's address.

## Install deps

```
sudo apt-get install jq
npm install
```

## Create directory for application data

We use the link:var[] directory to store application data.  In this repo, it is checked in for demonstration purposes.

```
mkdir var
```

## Generate keys for admin as well as bounty offerer and claimant

We use the link:generate-keys.mjs[] script to generate addresses (e.g. link:var/admin.addr[]), pubkey hashes (e.g. link:var/admin.pkh[]), and private keys (e.g. link:var/admin.skey[]) for an admin, a bounty offerer, and a bounty claimant.

```
node generate-keys.mjs var/admin
node generate-keys.mjs var/offerer
node generate-keys.mjs var/claimant
```

## Set up Blockfrost provider

Replace YOUR_BLOCKFROST_API_KEY and call the following command to create link:var/blockfrost.api-key[].

```
echo YOUR_BLOCKFROST_API_KEY > var/blockfrost.api-key
```

## Get funds from testnet faucet

Get the admin's address from link:var/admin.addr[]:

```
cat var/admin.addr
```

Go to https://docs.cardano.org/cardano-testnets/tools/faucet/

Send funds to the admin address.

## Distribute some Ada to bounty offerer and claimant

We use the link:send-lovelace.mjs[] script to send some Ada for paying fees to the bounty offerer and claimant.

```
node send-lovelace.mjs var/offerer
node send-lovelace.mjs var/claimant
```

## Create NFT minting policy

Supplies the admin's public key hash as input to the link:../app/GenMintingPolicyBlueprint.hs[] command to produce the link:var/sky-minting-policy.json[] minting policy Blueprint JSON from link:../src/SkyMintingPolicy.hs[].

```
cabal run gen-minting-policy-blueprint -- "$(cat var/admin.pkh)" var/sky-minting-policy.json
```

## Extract bridge validator and minting policy hashes

Use jq to extract the hashes from the policy files for later use.

```
cat var/sky-bridge-validator.json | jq -r '.validators[0].hash' > var/sky-bridge-validator.hash
cat var/sky-minting-policy.json | jq -r '.validators[0].hash' > var/sky-minting-policy.hash
```

## Generate Bridge Validator

Supply the minting policy hash from link:var/sky-minting-policy.hash[] as argument to the link:../app/GenValidatorBlueprint.hs[] command in order to produce the link:var/sky-bridge-validator.json[] Blueprint JSON for the validator from link:../src/SkyContracts.hs[].

```
cabal run gen-validator-blueprint -- "$(cat var/sky-minting-policy.hash)" var/sky-bridge-validator.json
```

## Mint the NFT at the bridge's address

Now that we have the validator script in link:var/sky-bridge-validator.json[], we can mint the NFT and lock it at the address of the validator with the link:mint-nft.mjs[] script.

```
node mint-nft.mjs
```

The NFT locked at the address on the Preview testnet can be viewed here:

https://preview.cardanoscan.io/tokenHoldings/addr_test1wqvwnk2mcdx92f9grcahrqcx47r0zk3vgrnw02mdqzclmsq8lfgue

## Updating the Bridge

https://cyphr.me/ed25519_tool/ed.html

Private key: 9DC6A2200837A9910689458F5D278A7D6BE396096EF6DADCE2C0C89165A0640C
Public key: F710662FC12F8852CBA4BAD811E770005A6E5311DA328D12FA5A46AEC707C405

```
node update-bridge.mjs $PUBLIC_KEY $NEW_TOP_HASH $SIG
# TBD: Add old data hash to arguments
```

## Generate Top Hash

cabal run gen-top-hash F710662FC12F8852CBA4BAD811E770005A6E5311DA328D12FA5A46AEC707C405 0000 1111
tophash: c7fbd27ca6bd42121f4fc1ff6a961a75038bcdf589518693b37f93e6e8934456
pubkeyhash: 4b4f90f0670c7d8d26949bfc1b90de7e12a572094ec1cdf23fec3e1f9a4bcf71

## Sign it

603456C8085568E54B20ABD11F7EAEC8AD731F61D0E3EA3BF8DEF43B72597F17AB4B0A26D952429B90EE8E8357E859D93E29E3DBAE53DEA51BCCD5B4CFB8E904

## Generate Bounty Validator

```
cabal run gen-bounty-blueprint -- "$(cat var/sky-minting-policy.hash)" 1111 var/sky-bounty-validator.json
```

## Offer bounty

```
node offer-bounty.mjs
```

bounty: addr_test1wzhgcuuc66c6r3stzu3a4v9pv82pg6v2yjtgezdrg9dtsxqmj9zxc
tx: af77b3cd538f7879e77af5f983a8e3586120263db0232f68a933fd9a6561c5ef

## Claim bounty

```
node claim-bounty.mjs 0000 1111 4b4f90f0670c7d8d26949bfc1b90de7e12a572094ec1cdf23fec3e1f9a4bcf71
```
